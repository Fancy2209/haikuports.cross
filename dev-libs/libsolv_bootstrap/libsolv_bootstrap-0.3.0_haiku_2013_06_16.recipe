SUMMARY="Library for solving packages and reading repositories"
DESCRIPTION="Library for solving packages and reading repositories."
LICENSE="BSD (3-clause)"
COPYRIGHT="2007-2013, Novell Inc."
HOMEPAGE="http://github.com/openSUSE/libsolv" 
SRC_URI="git+git://github.com/weinhold/libsolv.git#ef4a8778ef567224feb35019b711507ae1d6e7c3"
REVISION="1"
ARCHITECTURES="x86_gcc2 ?x86"

PROVIDES="
	libsolv_bootstrap = $portVersion
	libsolv = $portVersion
	lib:libsolv = $portVersion
	lib:libsolvext = $portVersion
	"
REQUIRES="
	haiku >= $haikuVersion
	lib:libz
	"
BUILD_REQUIRES="
	devel:libz
	"
BUILD_PREREQUIRES="
	haiku_devel >= $haikuVersion
	cmd:cmake
	cmd:gcc
	cmd:ld
	cmd:make
	cmd:sed
	"

SOURCE_DIR="libsolv-$portVersion"

BUILD()
{
	rm -rf build
	mkdir build
	cd build

	# prepare a toolchain file
	cat > toolchain.cmake << EOF
		SET(CMAKE_SYSTEM_NAME Haiku)
		SET(CMAKE_SYSTEM_VERSION 1)
		SET(CMAKE_C_COMPILER $targetMachineTriple-gcc)
		SET(CMAKE_CXX_COMPILER $targetMachineTriple-g++)
		SET(CMAKE_FIND_ROOT_PATH $crossSysrootDir)
		SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
		SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
		SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
EOF

	local systemDir=$crossSysrootDir/boot/system
	local systemDevelLibDir=$systemDir/$relativeDevelopLibDir
	local zlibInstallDir=$systemDir
	cmake -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake \
		-DHAIKU=1 \
		-DZLIB_LIBRARY=$zlibInstallDir/$relativeDevelopLibDir/libz.so \
		-DZLIB_INCLUDE_DIR=$zlibInstallDir/$relativeIncludeDir \
		-DHAIKU_BE_LIBRARY=$systemDevelLibDir/libbe.so \
		-DHAIKU_NETWORK_LIBRARY=$systemDevelLibDir/libnetwork.so \
		-DHAIKU_PACKAGE_LIBRARY=$systemDevelLibDir/libpackage.so \
		-DCMAKE_INSTALL_PREFIX:PATH=$prefix ..
	make $jobArgs
}

INSTALL()
{
	cd build
	make DESTDIR=$installDestDir install

	# set up the develop directory correctly
	prepareInstalledDevelLibs libsolv libsolvext

	mkdir -p $installDestDir$includeDir
	mv $installDestDir$prefix/include/* $installDestDir$includeDir
	rmdir $installDestDir$prefix/include

	# move cmake files
	mkdir -p $installDestDir$dataDir
	mv $installDestDir$prefix/share/cmake $installDestDir$dataDir
	rmdir $installDestDir$prefix/share

	# We don't want the executables.
	rm -r $installDestDir$binDir

	# devel package
	packageEntries devel \
		$installDestDir$dataDir \
		$installDestDir$developDir
}

# ----- devel package -------------------------------------------------------

PROVIDES_devel="
	libsolv_bootstrap_devel = $portVersion
	libsolv_devel = $portVersion
	devel:libsolv = $portVersion
	devel:libsolvext = $portVersion
	"
REQUIRES_devel="
	libsolv_bootstrap == $portVersion base
	"
