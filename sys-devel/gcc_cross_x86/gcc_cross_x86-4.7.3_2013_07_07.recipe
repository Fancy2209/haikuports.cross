SUMMARY="C/C++ cross-compiler for target ${targetMachineTriple}"
DESCRIPTION="Standard compiler for x86 platform."
HOMEPAGE="http://gcc.gnu.org"
LICENSE="
	GNU GPL v2
	GNU LGPL v2
	"
COPYRIGHT="1988-2013 Free Software Foundation, Inc."

# determine recipe architecture from port name
recipeArchitecture=$(echo $portName | cut -d_ -f3)

SRC_URI="
	git+file://$portBaseDir/../binutils_cross_${recipeArchitecture}/download/buildtools.git#db2a6d28f6c6a92cfb1c619b0828dfbf6b87ca30
	git+https://github.com/haiku/buildtools.git#db2a6d28f6c6a92cfb1c619b0828dfbf6b87ca30
	"
REVISION="1"
ARCHITECTURES="x86"

PROVIDES="
	gcc_cross_${recipeArchitecture} = $portVersion compat >= 4.7
	cmd:${targetMachineTripleAsName}_c++ = $portVersion compat >= 4.7
	cmd:${targetMachineTripleAsName}_cc = $portVersion compat >= 4.7
	cmd:${targetMachineTripleAsName}_cpp = $portVersion compat >= 4.7
	cmd:${targetMachineTripleAsName}_g++ = $portVersion compat >= 4.7
	cmd:${targetMachineTripleAsName}_gcc = $portVersion compat >= 4.7
	cmd:${targetMachineTripleAsName}_gcc_4.7.3 = $portVersion compat >= 4.7
	cmd:${targetMachineTripleAsName}_gcov = $portVersion compat >= 4.7
	"

REQUIRES="
	haiku >= $haikuVersion
	haiku_cross_devel_${recipeArchitecture} >= $haikuVersion
	"
BUILD_REQUIRES="
	haiku_cross_devel_${recipeArchitecture} >= $haikuVersion
	"
BUILD_PREREQUIRES="
	haiku_devel >= $haikuVersion
	binutils_cross_${recipeArchitecture}
	cmd:autoconf
	cmd:flex
	cmd:gcc
	cmd:ld
	cmd:make
	cmd:makeinfo
	cmd:sed
	cmd:tar
	zlib_devel
	"

SOURCE_DIR="$portVersionedName/gcc"

sourceDir=$(pwd)
relativeInstallDir="develop/tools/${portVersionedName}"
installDir="$prefix/$relativeInstallDir"
toolsBinDir="$prefix/develop/tools/bin"
objectsDir=$(pwd)/../${portVersionedName}-obj

compilerVersion=$(echo $portVersion | cut -d_ -f1)
developToolsDir=$portPackageLinksDir/binutils_cross_${recipeArchitecture}/develop/tools

BUILD()
{
	if [ $recipeArchitecture != $targetArchitecture ]; then
		echo "*** refusing to build $portName for $targetArchitecture"
		echo "*** please set appropriate target architecture in haikuports.conf"
		exit 1
	fi

# TODO: drop this once we have a proper gcc4 compiler
mkdir -p /boot/develop
ln -sfn /boot/common/develop/abi /boot/develop/abi
ln -sfn /boot/system/develop/headers /boot/develop/headers

	rm -rf $objectsDir

	# Touch some files generated by bison, so that bison won't run to update
	# them. Fixes issues with newer bison versions.
	# And while at it, touch gperf target, too (as gperf may not be installed).
	(cd $sourceDir/gcc; touch c-parse.c c-parse.h cexp.c cp/parse.c \
		cp/parse.h c-gperf.h)

	mkdir -p $objectsDir
	cd $objectsDir

	CFLAGS="-O2 -U_FORTIFY_SOURCE" CXXFLAGS="-O2" "$sourceDir/configure" \
		--build=$buildMachineTriple --host=$buildMachineTriple \
		--target=$targetMachineTriple --prefix=$installDir \
		--libexecdir=$installDir/lib --mandir=$manDir \
		--disable-nls --disable-shared \
		--enable-languages=c,c++ --enable-lto --enable-frame-pointer \
		--with-pkgversion=$(echo $portVersion | cut -c 7-) \
		--with-sysroot=$crossSysrootDir

	make
}

INSTALL()
{
# TODO: drop this once we have a proper gcc4 compiler
mkdir -p /boot/develop
ln -sfn /boot/common/develop/abi /boot/develop/abi
ln -sfn /boot/system/develop/headers /boot/develop/headers

	cd $objectsDir
	make install

	### Symlinks ##############################################

	echo "Creating required symlinks"

	# convert to absolute links to relative ones
	cd $installDir/bin
	ln -sfn $targetMachineTriple-g++ $targetMachineTriple-c++
	ln -sfn $targetMachineTriple-gcc $targetMachineTriple-cc

	# make all commands available in develop/tools/bin (which
	# haikuporter will add to the path when cross building)
	mkdir -p $toolsBinDir
	cd $toolsBinDir
	ln -sfn ../${portVersionedName}/bin/* .

	### Strip #################################################

	echo "Strip debug info"

	strip --strip-debug $installDir/bin/*
	cd $installDir/lib/gcc/$targetMachineTriple/$compilerVersion
	for f in cc1 cc1plus collect2 lto1; do
		strip --strip-debug $f
	done
	strip --strip-debug $installDir/$targetMachineTriple/lib/*.a

	### Cleanup ###############################################

	echo "Cleanup"
	rm -rf $installDir/info
	rm -rf $installDir/share
}
