SUMMARY="C/C++ cross-compiler for target ${effectiveTargetMachineTriple}"
DESCRIPTION="Standard compiler for x86_gcc2 platform, ABI-compatible with BeOS R5."
HOMEPAGE="http://gcc.gnu.org"
LICENSE="
	GNU GPL v2
	GNU LGPL v2
	"

COPYRIGHT="1988-2000 Free Software Foundation, Inc."
SRC_URI="
	git+file://$portBaseDir/../gcc_cross_x86_gcc2/download/buildtools.git#6ff546f23b0259bcd27550aa6ad8aaef89fd1bf6
	git+file://$portBaseDir/../binutils_bootstrap/download/buildtools.git#6ff546f23b0259bcd27550aa6ad8aaef89fd1bf6
	git+https://github.com/haiku/buildtools.git#6ff546f23b0259bcd27550aa6ad8aaef89fd1bf6
	"
REVISION="1"

ARCHITECTURES="x86_gcc2"
if [ $effectiveTargetArchitecture = x86_gcc2 -a $targetArchitecture = x86 ]
then
	ARCHITECTURES="$ARCHITECTURES x86"
fi
SECONDARY_ARCHITECTURES="x86_gcc2"

PROVIDES="
	gcc_bootstrap$secondaryArchSuffix = $portVersion compat >= 2.95.3
	gcc$secondaryArchSuffix = $portVersion compat >= 2.95.3
	cmd:c++$secondaryArchSuffix = $portVersion compat >= 2.95.3
	cmd:c++filt$secondaryArchSuffix = $portVersion compat >= 2.95.3
	cmd:cc$secondaryArchSuffix = $portVersion compat >= 2.95.3
	cmd:cpp$secondaryArchSuffix = $portVersion compat >= 2.95.3
	cmd:g++$secondaryArchSuffix = $portVersion compat >= 2.95.3
	cmd:gcc$secondaryArchSuffix = $portVersion compat >= 2.95.3
	cmd:gcov$secondaryArchSuffix = 1.5 compat >= 1.5
	cmd:protoize$secondaryArchSuffix = $portVersion compat >= 2.95.3
	cmd:unprotoize$secondaryArchSuffix = $portVersion compat >= 2.95.3
	"

REQUIRES="
	haiku$secondaryArchSuffix >= $haikuVersion
	"
BUILD_REQUIRES="
	"
BUILD_PREREQUIRES="
	haiku${secondaryArchSuffix}_devel >= $haikuVersion
	binutils_cross_${effectiveTargetArchitecture}
	gcc_cross_${effectiveTargetArchitecture}
	cmd:autoconf
	cmd:flex
	cmd:gcc
	cmd:ld
	cmd:make
	cmd:sed
	cmd:tar
	cmd:makeinfo
	"

SOURCE_DIR="$portVersionedName/legacy/gcc"
BUILD_PACKAGE_ACTIVATION_PHASE=INSTALL

sourceDir=$(pwd)
relativeInstallDir="develop/tools$secondaryArchSubDir"
installDir="$prefix/$relativeInstallDir"
objectsDir=$(pwd)/../${portVersionedName}-obj

BUILD()
{
	rm -rf $objectsDir

	# Touch some files generated by bison, so that bison won't run to update
	# them. Fixes issues with newer bison versions.
	# And while at it, touch gperf target, too (as gperf may not be installed).
	(cd $sourceDir/gcc; touch c-parse.c c-parse.h cexp.c cp/parse.c \
		cp/parse.h c-gperf.h)

	mkdir -p $objectsDir
	cd $objectsDir

	local additionalConfigureFlags
	if [ -n "$secondaryArchSuffix" ]; then
		additionalConfigureFlags="\
			--with-hybrid-secondary=${effectiveTargetArchitecture}"
	fi

	CFLAGS="-O2 -U_FORTIFY_SOURCE" CXXFLAGS="-O2" "$sourceDir/configure" \
		--build=$buildMachineTriple --host=$effectiveTargetMachineTriple \
		--target=$effectiveTargetMachineTriple --prefix=$installDir \
		--disable-nls --enable-shared --enable-languages=c,c++ \
		$additionalConfigureFlags

	make

	# the generated specs file insists on defaulting to a cross-compiler
	sed -i \
		'/^\*cross_compile:$/{ N; s/\*cross_compile:\n1/*cross_compile:\n0/ }' \
		gcc/specs
}

INSTALL()
{
	cd $objectsDir
	make prefix=$installDestDir$installDir install
		# no DESTDIR support

	### Symlinks ##############################################

	echo "Creating required symlinks"

	# convert absolute links to relative ones
	cd $installDestDir$installDir/bin
	ln -sfn g++ c++
	ln -sfn gcc cc
	ln -sfn gcc $effectiveTargetMachineTriple-gcc

	# make all tools available via default paths
	echo "Symlinking binaries into default path"
	mkdir -p $installDestDir$binDir
	symlinkRelative -s $installDestDir$installDir/bin/* $installDestDir$binDir

	### Strip #################################################

	echo "Strip debug info"

	cd $installDestDir$installDir
	strip --strip-debug bin/*
	strip --strip-debug \
		lib/gcc-lib/$effectiveTargetMachineTriple/2.95.3-haiku-*/* \
		  &>/dev/null || true

	### Cleanup ###############################################

	echo "Cleanup"

	cd $installDestDir$installDir
	rm -rf info
	rm -rf share
	rm man/man1/cccp.1

	### C++ includes ##########################################

	echo "Install C++ includes & library"

	rm -rf include/g++
	ln -snf /boot/system/develop/headers/c++/2.95.3 include/g++

	ln -snf /boot/system/develop/lib/libstdc++.r4.so lib/
}
