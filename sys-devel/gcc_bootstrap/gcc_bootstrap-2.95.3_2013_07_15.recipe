SUMMARY="C/C++ cross-compiler for target ${targetMachineTriple}"
DESCRIPTION="Standard compiler for x86_gcc2 platform, ABI-compatible with BeOS R5."
HOMEPAGE="http://gcc.gnu.org"
LICENSE="
	GNU GPL v2
	GNU LGPL v2
	"

COPYRIGHT="1988-2000 Free Software Foundation, Inc."
SRC_URI="
	git+file://$portBaseDir/../gcc_cross_x86_gcc2/download/BuildtoolsPM.git#bb9d132
	git+git://github.com/haiku/BuildtoolsPM.git#bb9d132
	"
REVISION="2"
ARCHITECTURES="x86_gcc2"

PROVIDES="
	gcc_bootstrap = $portVersion compat >= 2.95.3
	cmd:c++ = $portVersion compat >= 2.95.3
	cmd:c++filt = $portVersion compat >= 2.95.3
	cmd:cc = $portVersion compat >= 2.95.3
	cmd:cpp = $portVersion compat >= 2.95.3
	cmd:g++ = $portVersion compat >= 2.95.3
	cmd:gcc = $portVersion compat >= 2.95.3
	cmd:gcov = 1.5 compat >= 1.5
	cmd:i586_pc_haiku_gcc2_gcc = $portVersion compat >= 2.95.3
	cmd:protoize = $portVersion compat >= 2.95.3
	cmd:unprotoize = $portVersion compat >= 2.95.3
	"

REQUIRES="
	haiku >= $haikuVersion
	"
BUILD_REQUIRES="
	$REQUIRES
	binutils_cross_${targetArchitecture}
	gcc_cross_${targetArchitecture}
	"
BUILD_PREREQUIRES="
	haiku_devel >= $haikuVersion
	cmd:autoconf
	cmd:flex
	cmd:gcc
	cmd:ld
	cmd:make
	cmd:sed
	cmd:tar
	cmd:makeinfo
	"

SOURCE_DIR="$portVersionedName/legacy/gcc"
BUILD_PACKAGE_ACTIVATION_PHASE=INSTALL

sourceDir=$(pwd)
relativeInstallDir="develop/tools/${portVersionedName}"
installDir="$prefix/$relativeInstallDir"
toolsBinDir="$prefix/develop/tools/bin"
objectsDir=$(pwd)/../${portVersionedName}-obj

BUILD()
{
	rm -rf $objectsDir

	# Touch some files generated by bison, so that bison won't run to update
	# them. Fixes issues with newer bison versions.
	# And while at it, touch gperf target, too (as gperf may not be installed).
	(cd $sourceDir/gcc; touch c-parse.c c-parse.h cexp.c cp/parse.c \
		cp/parse.h c-gperf.h)

	mkdir -p $objectsDir
	cd $objectsDir

	CFLAGS="-O2 -U_FORTIFY_SOURCE" CXXFLAGS="-O2" "$sourceDir/configure" \
		--build=$buildMachineTriple --host=$targetMachineTriple \
		--target=$targetMachineTriple --prefix=$installDir \
		--disable-nls --enable-shared --enable-languages=c,c++

	make || true
		# The above will fail when compiling builtinbuf.cc, but we can ignore
		# that since it's trying to build libstdc++.so, which haiku provides
		# anyway.
}

INSTALL()
{
	cd $objectsDir
	make install

	### Symlinks ##############################################

	echo "Creating required symlinks"

	# convert absolute links to relative ones
	cd $installDir/bin
	ln -sfn g++ c++
	ln -sfn gcc cc
	ln -sfn gcc i586-pc-haiku_gcc2-gcc
	
	# make all tools available via default paths
	echo "Symlinking binaries into default path"
	mkdir -p $prefix/bin
	cd $prefix/bin
	ln -sfn ../$relativeInstallDir/bin/* .
	
	### Strip #################################################
	
	echo "Strip debug info"

	cd $installDir
	strip --strip-debug bin/*
	strip --strip-debug lib/gcc-lib/$targetMachineTriple/2.95.3-haiku-*/* \
		  &>/dev/null || true
	
	### Cleanup ###############################################
	
	echo "Cleanup"
	
	cd $installDir
	rm -rf info
	rm -rf share
	rm man/man1/cccp.1
	
	### C++ includes ##########################################
	
	echo "Install C++ includes & library"
	
	rm -rf include/g++
	ln -snf /boot/system/develop/headers/c++/2.95.3 include/g++
	
	ln -snf /boot/system/develop/lib/libstdc++.r4.so lib/
}
